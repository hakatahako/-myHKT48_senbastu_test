<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY HKT48 선발</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #fce4ec;
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            line-height: 1.6;
        }
        /* 바닥판 */
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
            width: 100%;
            max-width: 1160px;
            box-sizing: border-box;
            position: relative;
        }
        h1 {
            color: #ad1457;
            margin-bottom: 25px;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        h2 {
            color: #7b1fa2;
            margin-top: 20px;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .round-info {
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
            margin-bottom: 25px;
        }
        .member-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        /* 멤버카드 (분홍색 판) - PC 기본 스타일 */
        .member-card {
            background-color: #ffebee;
            border: 2px solid #ffccbc;
            border-radius: 15px;
            padding: 15px; /* PC 패딩 줄임 */
            width: 370px;
            min-width: 370px;
            flex-shrink: 0;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column; /* PC: 세로형 */
            align-items: center;
            box-sizing: border-box;
            position: relative;
        }
        .member-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border-color: #ff8a65;
        }
        .member-card.selected {
            border: 4px solid #ad1457;
            background-color: #ffebf0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            transform: translateY(-8px) scale(1.02);
        }
        .member-card.processed {
            pointer-events: none;
            opacity: 0.8;
        }

        /* 멤버 사진 - PC 기본 스타일 */
        .member-card img {
            width: 350px;
            height: 350px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px; /* PC 이미지 아래 여백 줄임 */
            transition: border-color 0.2s;
        }
        .member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.3em;
            word-break: keep-all;
        }

        /* 순위 표시 스타일 */
        .selection-rank {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: #ad1457;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .member-card.selected .selection-rank {
            opacity: 1;
        }

        .button-group {
            margin-top: 40px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            letter-spacing: 1px;
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        #resetGameButton {
            background-color: #f44336;
            color: white;
            margin-top: 20px; /* PC에서는 기존 위치 유지 */
        }
        #resetGameButton:hover {
            background-color: #d32f2f;
        }

        /* 결과 화면 스타일 */
        .results-screen {
            display: none;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px dashed #eee;
            text-align: left;
        }
        .results-screen h2 {
            text-align: center;
            color: #ad1457;
            font-size: 2.2em;
            margin-bottom: 30px;
        }
        .top-members {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 30px; /* 이미지 크기 증가에 맞춰 간격 조정 */
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .top-member-card {
            background-color: #fdf3f7;
            border-radius: 15px;
            padding: 30px; /* 패딩 늘림 */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            box-sizing: border-box;
            position: relative;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        /* 1위 카드 스타일 (2,3위보다 10% 더 크게) */
        .top-member-card.rank1 {
            width: calc(247.5px + 60px + 8px);
            height: auto;
            border: 4px solid #FFD700;
            background-color: #FFFACD;
            transform: translateY(-30px);
            order: 2;
        }
        .top-member-card.rank1 img {
            width: 247.5px;
            height: 247.5px;
        }

        /* 2, 3위 카드 스타일 (기준 크기) */
        .top-member-card.rank2, .top-member-card.rank3 {
            width: calc(225px + 60px + 8px);
            height: auto;
            border: 4px solid #C0C0C0;
            background-color: #E0E0E0;
            order: 1;
        }
        .top-member-card.rank3 {
            border: 4px solid #CD7F32;
            background-color: #D2B48C;
            order: 3;
        }
        .top-member-card.rank2 img, .top-member-card.rank3 img {
            width: 225px;
            height: 225px;
        }

        .top-member-card img {
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
        }
        .top-member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.4em;
            margin-bottom: 5px;
        }
        .top-member-card .score {
            font-size: 1.2em;
            color: #555;
            font-weight: normal;
            display: none; /* 점수 표시 비활성화 */
        }
        .rank-label {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ad1457;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .rank1 .rank-label { background-color: #FFD700; color: #333; }
        .rank2 .rank-label { background-color: #C0C0C0; color: #333; }
        .rank3 .rank-label { background-color: #CD7F32; color: white; }

        .final-selection-list {
            margin-top: 30px;
            text-align: center;
            font-size: 1.1em;
            color: #555;
        }
        .final-selection-list h3 {
            color: #7b1fa2;
            margin-bottom: 15px;
            font-size: 1.6em;
        }
        .final-selection-list ul {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 700px;
            margin: 0 auto;
        }
        .final-selection-list li {
            background-color: #e3f2fd;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #bbdefb;
            font-weight: bold;
            color: #2196F3;
        }
        .restart-button-group {
            margin-top: 40px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .restart-button-group button {
            width: 250px;
        }
        /* 동점자 라운드 시 표시될 안내 텍스트 스타일 */
        .tie-breaker-info {
            font-weight: bold;
            color: #ad1457;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: none;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
                max-width: 95%;
            }
            h1 {
                font-size: 1.8em;
            }
            /* 모바일에서 라운드 정보와 '오늘의 멤버' 문구 숨김 */
            .round-info, h2 {
                display: none;
            }
            /* 모바일 상단 안내 글자 간략화 및 크기 조정 */
            #instructionText {
                font-size: 0.9em;
                margin-top: 0;
                margin-bottom: 15px;
            }
            .member-display {
                flex-direction: column;
                align-items: center;
                gap: 10px;
                margin-top: 15px;
            }
            /* 멤버카드 - 모바일: 가로형 */
            .member-card {
                width: 95%;
                max-width: 350px;
                min-width: unset;
                padding: 8px 10px;
                flex-direction: row;
                justify-content: flex-start;
                align-items: center;
                gap: 8px;
            }
            .member-card:hover {
                transform: none;
                box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
            }
            .member-card.selected {
                transform: none;
            }

            /* 멤버 사진 - 모바일: 크기 20% 더 키움 */
            .member-card img {
                width: 72px; /* 60px * 1.2 = 72px */
                height: 72px; /* 60px * 1.2 = 72px */
                border-radius: 50%;
                object-fit: cover;
                margin-bottom: 0;
                flex-shrink: 0;
            }
            .member-card p {
                font-size: 1.1em;
                text-align: left;
                flex-grow: 1;
            }
            .selection-rank {
                top: 50%;
                left: unset;
                right: 8px;
                transform: translateY(-50%);
                width: 25px;
                height: 25px;
                font-size: 0.9em;
            }

            .button-group {
                flex-direction: column;
                gap: 10px;
                margin-top: 20px;
            }
            button {
                width: 90%;
                padding: 12px 20px;
                font-size: 1.1em;
            }
            /* 게임 초기화 버튼 모바일 스타일 변경 */
            #resetGameButton {
                width: 120px; /* 더 작게 */
                padding: 8px 15px; /* 패딩도 줄임 */
                font-size: 0.9em; /* 폰트도 작게 */
                margin-top: 0; /* 상단 마진 제거 */
                align-self: center; /* 가운데 정렬 */
                order: 10; /* 다른 버튼보다 아래로 내림 */
            }

            .top-members {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            .top-member-card {
                width: 90%;
                transform: none !important;
                order: initial !important;
            }
            .top-member-card.rank1 img {
                width: 180px;
                height: 180px;
            }
            .top-member-card.rank2 img, .top-member-card.rank3 img {
                width: 150px;
                height: 150px;
            }
            .restart-button-group button {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MY HKT48 선발</h1>
        <p id="instructionText" style="font-weight: bold; color: #ad1457;"></p>
        <p id="tieBreakerInfo" class="tie-breaker-info" style="display: none;">공동 1등 재대결 라운드!</p>

        <div id="gameScreen">
            <div class="round-info">
                <span id="currentRound"></span> 라운드
            </div>
            <h2 id="selectionInstruction">3명 중 좋아하는 순서대로 2명을 선택하세요!</h2>
            <div class="member-display" id="memberSelection">
            </div>
            <div class="button-group">
                <button id="resetGameButton">게임 초기화</button>
            </div>
        </div>

        <div id="resultsScreen" class="results-screen">
            <h2 id="resultsScreenTitle">🎉 최종 선발 결과! 🎉</h2>
            <div class="top-members" id="topMembersDisplay">
            </div>
            <div class="final-selection-list">
                <h3 id="finalSelectionListTitle">💖 최종 선발 16인 💖</h3>
                <ul id="finalSelectionList">
                </ul>
            </div>
            <div class="restart-button-group">
                <button id="downloadTextResultButton">결과 저장 (텍스트)</button>
                <button id="downloadImageResultButton">결과 저장 (이미지)</button>
                <button id="restartGameButton">새 게임 시작</button>
            </div>
        </div>
    </div>

    <script>
        const memberNames = [
            "나가노 라라", "나카노 미나미", "다나카 이오리", "류토 아야네", "마츠나가 유이", "마츠모토 모카",
            "모리사키 사아야", "사카모토 리노", "시부이 미나", "아오키 히나코", "아키요시 유카","야나세 레이아","야마우치 유나","야마카와 마리아",
            "야스이 히나", "에구치 코코하", "에우라 유카", "오오바 리사키", "오오우치 린카", "요시다 메이", "이마무라 마리아", "이시마츠 유이나",
            "이시바시 이부키", "이시이 아야네", "이시카와 아미유", "이하라 한나", "이자와 미유", "이지마 리리아", "이치무라 아이리", "이쿠노 리나",
            "지토우에 네네", "츠루카와 나치", "츠츠미 후카", "카타히라 사라", "쿠레 유나", "쿠리야마 리나", "쿠리하라 사에", "키타가와 히이로",
            "타치바나 코코로", "타케모토 쿠루미", "토요나가 아키", "후지노 코코하", "후쿠이 카렌"
        ];

        let memberData = {};
        let currentRound = 0;
        // 게임 페이즈: 'initialSelection', 'finalSelection', 'tieBreakerForRank1', 'results'
        let gamePhase = 'initialSelection';
        let selectionOrder = []; // 현재 라운드에서 선택된 멤버들의 이름 (순서대로)
        let availableMembersForRound = []; // 현재 라운드에 표시될 멤버들

        const maxAppearances = 3; // 페이즈 1: 한 멤버는 3회 이상 등장하지 않음
        const maxZeroScoreCount = 3; // 페이즈 1: 0점 3번 받으면 탈락

        const membersPerRoundPhase1 = 3; // 페이즈 1에서 보여주는 멤버 수 (3명)
        const membersPerRoundPhase2 = 2; // 페이즈 2에서 보여주는 멤버 수 (2명)

        const initialSelectionTarget = 16; // 1차 선발 목표 인원 (페이즈 1 종료 조건)

        // 점수 정의
        const scores = {
            phase1: { // 1차 선발 단계 점수
                rank1: 5, // 1순위
                rank2: 3, // 2순위
                rank3: 0  // 3순위 (선택 없음)
            },
            phase2: { // 센터 선발 단계 점수
                selected: 3,   // 선택 받은 멤버
                notSelected: 1 // 선택 받지 못한 멤버
            },
            tieBreakerForRank1: { // 1등 동점자 결승 라운드 점수
                rank1: 20, // 1순위
                rank2: 10  // 2순위
            }
        };

        const instructionTextElement = document.getElementById('instructionText');
        const currentRoundElement = document.getElementById('currentRound');
        const selectionInstructionElement = document.getElementById('selectionInstruction'); // h2 태그
        const memberSelectionDiv = document.getElementById('memberSelection');
        const gameScreen = document.getElementById('gameScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const topMembersDisplay = document.getElementById('topMembersDisplay');
        const finalSelectionList = document.getElementById('finalSelectionList');
        const tieBreakerInfoElement = document.getElementById('tieBreakerInfo');

        function initializeGame() {
            memberData = {};
            memberNames.forEach(name => {
                memberData[name] = {
                    score: 0,
                    appearances: 0, // 페이즈 1 등장 횟수
                    zeroScoreCount: 0, // 페이즈 1: 0점 받은 횟수
                    notSelectedCountPhase2: 0, // 페이즈 2: 선택받지 못한 횟수 (1점 받은 횟수)
                    eliminated: false, // 페이즈 1 탈락 기준
                    eliminatedPhase2: false, // 페이즈 2 탈락 기준
                    lastSeen: -1, // 마지막 등장 라운드
                    previousRoundGroup: new Set(), // 함께 등장했던 멤버들 기록 (세트)
                    firstRankSelections: 0, // 1순위 선택 받은 횟수 (페이즈1: 5점, 페이즈2: 3점, 결승: 20점)
                    secondRankSelections: 0 // 2순위 선택 받은 횟수 (페이즈1: 3점, 결승: 10점)
                };
            });
            currentRound = 0;
            gamePhase = 'initialSelection';
            selectionOrder = [];
            availableMembersForRound = [];

            gameScreen.style.display = 'block';
            resultsScreen.style.display = 'none';
            tieBreakerInfoElement.style.display = 'none'; // 동점자 정보 초기화

            updateInstructionText();
            startNewRound();
        }

        function updateInstructionText() {
            const nonEliminatedCount = Object.values(memberData).filter(m => !m.eliminated && !m.eliminatedPhase2).length;
            if (gamePhase === 'initialSelection') {
                instructionTextElement.textContent = `현재 인원: ${nonEliminatedCount}명. ${initialSelectionTarget}명을 선발 중입니다.`;
                selectionInstructionElement.textContent = `3명 중 좋아하는 순서대로 2명을 선택하세요!`;
                tieBreakerInfoElement.style.display = 'none';
            } else if (gamePhase === 'finalSelection') {
                instructionTextElement.textContent = `최종 선발 16인이 결정되었습니다. 당신의 센터를 뽑아주세요! (남은 멤버: ${nonEliminatedCount}명)`;
                selectionInstructionElement.textContent = `2명 중 우승자를 선택하세요!`;
                tieBreakerInfoElement.style.display = 'none';
            } else if (gamePhase === 'tieBreakerForRank1') {
                instructionTextElement.textContent = `공동 1등 발생! 단독 1등을 가리기 위한 결승 라운드!`;
                selectionInstructionElement.textContent = `${availableMembersForRound.length}명 중 우승자를 선택하세요!`;
                tieBreakerInfoElement.style.display = 'block'; // 동점자 알림 표시
            } else if (gamePhase === 'results') {
                instructionTextElement.textContent = `게임이 종료되었습니다! 최종 결과를 확인하세요.`;
                selectionInstructionElement.textContent = ``;
                tieBreakerInfoElement.style.display = 'none';
            }
        }

        // 멤버 정렬 함수: 점수 > 1순위 득표수 > 2순위 득표수 > 무작위 순
        function getSortedMembers(includeEliminated = false) {
            let filteredMembers = Object.keys(memberData).map(name => ({
                name: name,
                score: memberData[name].score,
                firstRankSelections: memberData[name].firstRankSelections,
                secondRankSelections: memberData[name].secondRankSelections,
                eliminated: memberData[name].eliminated || memberData[name].eliminatedPhase2
            }));

            if (!includeEliminated) {
                filteredMembers = filteredMembers.filter(m => !m.eliminated);
            }

            return filteredMembers.sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                // 점수 동점 시 1순위 득표수 비교 (페이즈 2의 3점 득표수 포함)
                if (b.firstRankSelections !== a.firstRankSelections) {
                    return b.firstRankSelections - a.firstRankSelections;
                }
                // 1순위 득표수도 동점 시 2순위 득표수 비교 (페이즈 2의 1점 득표수는 여기 포함 안됨)
                if (b.secondRankSelections !== a.secondRankSelections) {
                    return b.secondRankSelections - a.secondRankSelections;
                }
                // 최종 무작위
                return Math.random() - 0.5;
            });
        }


        function getEligibleMembersForRound() {
            let eligible = Object.keys(memberData).filter(name => !memberData[name].eliminated && !memberData[name].eliminatedPhase2);

            if (gamePhase === 'initialSelection') {
                // 페이즈 1에서는 등장 횟수 제한 적용
                eligible = eligible.filter(name => memberData[name].appearances < maxAppearances);
            } else if (gamePhase === 'finalSelection') {
                // 페이즈 2에서는 등장 횟수 제한 없고, 4번 이상 선택받지 못한 멤버는 제외
                eligible = eligible.filter(name => memberData[name].notSelectedCountPhase2 < 4);

                // 현재 상위 16명 내의 멤버만 라운드에 등장하도록 (남은 멤버 중)
                const sortedMembers = getSortedMembers(false);
                const currentTop16Names = sortedMembers.slice(0, initialSelectionTarget).map(m => m.name);
                eligible = eligible.filter(name => currentTop16Names.includes(name));

                // 2명씩 대결이므로, 최소 2명은 있어야 라운드 진행 가능
                if (eligible.length < membersPerRoundPhase2) {
                    return []; // 라운드를 진행할 수 없는 경우 빈 배열 반환
                }

            } else if (gamePhase === 'tieBreakerForRank1') {
                // 공동 1등 동점자 라운드: 현재 최고 점수 멤버들만 대상으로 하고, 등장 횟수 제한 없음
                const sortedMembers = getSortedMembers(false);
                if (sortedMembers.length === 0) return [];

                const topScore = sortedMembers[0].score;
                eligible = sortedMembers.filter(m => m.score === topScore).map(m => m.name);

                // 결승 라운드에서도 2명 대결이므로, 최소 2명은 있어야 진행 가능
                if (eligible.length < membersPerRoundPhase2) {
                    return [];
                }
            }
            return eligible;
        }

        function selectMembersForRound() {
            let selected = [];
            let eligiblePool = getEligibleMembersForRound(); // 후보군 가져오기
            let attempts = 0;
            const maxAttempts = 500;

            const numMembersToSelect = (gamePhase === 'initialSelection') ? membersPerRoundPhase1 : membersPerRoundPhase2;

            // 라운드에 필요한 최소 멤버 수 체크
            if (eligiblePool.length < numMembersToSelect) {
                // 게임 종료 또는 다음 페이즈로 전환 로직은 startNewRound에서 처리
                return [];
            }

            // eligiblePool 멤버들을 섞어서 무작위성을 높임
            eligiblePool.sort(() => Math.random() - 0.5);

            while (selected.length < numMembersToSelect && eligiblePool.length > 0 && attempts < maxAttempts) {
                const candidate = eligiblePool.shift(); // 앞에서부터 하나씩 시도

                let canAdd = true;
                // "같이 등장했던 멤버도 함께 나오지 않으며" 규칙 적용 (페이즈 1에만 해당)
                if (gamePhase === 'initialSelection') {
                    for (const existingMember of selected) {
                        if (memberData[existingMember].previousRoundGroup.has(candidate) ||
                            memberData[candidate].previousRoundGroup.has(existingMember)) { // 양방향 체크
                            canAdd = false;
                            break;
                        }
                    }
                }

                if (canAdd) {
                    selected.push(candidate);
                } else {
                    // 추가할 수 없으면 eligiblePool 뒤로 다시 보내서 다음 시도에 사용
                    eligiblePool.push(candidate);
                }
                attempts++;
            }

            // 만약 충분한 멤버를 뽑지 못했으면, 규칙을 완화하여 최대한 채움 (게임 진행을 위해)
            // (이 부분은 선택적으로, 강제 종료 대신 유연성을 주기 위함)
            if (selected.length < numMembersToSelect) {
                const allRemainingEligible = Object.keys(memberData).filter(name =>
                    !memberData[name].eliminated && !memberData[name].eliminatedPhase2 && !selected.includes(name)
                );

                // 부족한 수만큼 채움 (규칙 완화)
                const remainingToPick = allRemainingEligible.filter(name => !selected.includes(name));
                while (selected.length < numMembersToSelect && remainingToPick.length > 0) {
                    const randomMember = remainingToPick.splice(Math.floor(Math.random() * remainingToPick.length), 1)[0];
                    selected.push(randomMember);
                }
            }

            return selected;
        }


        function startNewRound() {
            currentRound++;
            currentRoundElement.textContent = currentRound;
            selectionOrder = []; // 새 라운드 시작 시 선택 순서 초기화
            memberSelectionDiv.innerHTML = ''; // 이전 멤버 카드 제거

            // 라운드에 등장할 멤버 선택
            availableMembersForRound = selectMembersForRound();

            // 게임 페이즈 전환 및 종료 로직
            const nonEliminatedCount = Object.values(memberData).filter(m => !m.eliminated && !m.eliminatedPhase2).length;
            const sortedMembers = getSortedMembers(false); // 현재 점수 기준 정렬 (탈락자 제외)

            if (availableMembersForRound.length === 0) { // 라운드를 진행할 멤버가 없으면
                 // 공동 1등 재대결 중 멤버가 1명만 남았다면 그 멤버가 우승
                if (gamePhase === 'tieBreakerForRank1' && sortedMembers.length === 1) {
                    alert(`단독 1위: ${sortedMembers[0].name}이(가) 결정되었습니다!`);
                    gamePhase = 'results';
                    displayResults();
                    return;
                }
                alert("더 이상 라운드를 진행할 수 있는 멤버가 부족하여 게임을 종료합니다.");
                gamePhase = 'results';
                displayResults();
                return;
            }

            if (gamePhase === 'initialSelection') {
                if (nonEliminatedCount <= initialSelectionTarget) {
                    gamePhase = 'finalSelection';
                    currentRound = 0; // 2페이즈 시작을 알림
                    alert(`1차 선발이 완료되었습니다! 이제 최종 선발 16인을 위한 경쟁을 시작합니다.`);
                }
            } else if (gamePhase === 'finalSelection') {
                // 페이즈 2에서 1등 동점자가 발생했는지 확인
                const topScore = sortedMembers.length > 0 ? sortedMembers[0].score : -1;
                const topRankMembers = sortedMembers.filter(m => m.score === topScore);

                // 페이즈 2에서 1등이 1명만 남았을 경우 또는, 공동 1등이 2명 이상일 경우
                if (topRankMembers.length >= 2) {
                     // 현재 라운드에서 뽑을 멤버가 2명 미만일 경우에만 결승으로 진입
                    if (availableMembersForRound.length < membersPerRoundPhase2) {
                        gamePhase = 'tieBreakerForRank1';
                        currentRound = 0; // 결승 라운드 카운트 초기화
                        alert("공동 1등 발생! 단독 1등을 가리기 위한 결승 라운드로 진입합니다.");
                        availableMembersForRound = getEligibleMembersForRound(); // 결승 멤버 다시 선택
                    }
                }
            } else if (gamePhase === 'tieBreakerForRank1') {
                const topScore = sortedMembers.length > 0 ? sortedMembers[0].score : -1;
                const topRankMembers = sortedMembers.filter(m => m.score === topScore);

                if (topRankMembers.length === 1) { // 단독 1등이 결정됨
                    alert(`단독 1위: ${topRankMembers[0].name}이(가) 결정되었습니다!`);
                    gamePhase = 'results'; // 결과 화면으로 전환
                    displayResults();
                    return;
                } else {
                    // 아직 공동 1등이라면 다시 라운드 진행
                    alert("아직 공동 1등입니다! 다시 결승 라운드를 진행합니다.");
                    // availableMembersForRound는 getEligibleMembersForRound에서 다시 설정되므로
                    // 여기서는 추가적인 작업 없이 다음 라운드 렌더링으로 넘어감
                }
            }

            updateInstructionText();
            renderMembers();
        }

        function renderMembers() {
            memberSelectionDiv.innerHTML = '';

            if (availableMembersForRound.length === 0) {
                console.warn("렌더링할 멤버가 없습니다. 게임 상태를 확인하세요.");
                return;
            }

            // 페이즈 1에서는 3명, 페이즈 2와 결승에서는 2명 표시
            const numMembersToDisplay = (gamePhase === 'initialSelection') ? membersPerRoundPhase1 : membersPerRoundPhase2;
            const membersToRender = availableMembersForRound.slice(0, numMembersToDisplay);


            membersToRender.forEach(name => {
                const card = document.createElement('div');
                card.classList.add('member-card');
                card.dataset.name = name;
                card.innerHTML = `
                    <img src="./images/${name}.png" alt="${name}">
                    <p>${name}</p>
                    <div class="selection-rank"></div>
                `;
                card.addEventListener('click', handleCardClick);
                memberSelectionDiv.appendChild(card);
            });
        }

        function handleCardClick(event) {
            const clickedCard = event.currentTarget;
            const clickedMemberName = clickedCard.dataset.name;

            if (clickedCard.classList.contains('processed')) {
                return; // 이미 처리된 카드는 클릭 무시
            }

            // 선택 취소 로직 (가장 마지막에 선택된 것만 취소)
            const indexInSelection = selectionOrder.indexOf(clickedMemberName);
            if (indexInSelection !== -1) {
                if (indexInSelection === selectionOrder.length - 1) { // 마지막 선택 멤버인 경우에만 취소
                    selectionOrder.pop();
                    clickedCard.classList.remove('selected');
                    clickedCard.querySelector('.selection-rank').textContent = '';
                    clickedCard.querySelector('.selection-rank').style.opacity = '0';
                }
                return; // 이미 선택되었지만 마지막 선택이 아닌 경우 무시
            }

            // 새로운 선택 추가
            if (gamePhase === 'initialSelection') {
                if (selectionOrder.length < 2) {
                    selectionOrder.push(clickedMemberName);
                    clickedCard.classList.add('selected');
                    clickedCard.querySelector('.selection-rank').textContent = selectionOrder.length;
                    clickedCard.querySelector('.selection-rank').style.opacity = '1';
                }
                if (selectionOrder.length === 2) {
                    processRoundResults();
                }
            } else if (gamePhase === 'finalSelection' || gamePhase === 'tieBreakerForRank1') {
                if (selectionOrder.length < 1) { // 1명만 선택 가능
                    selectionOrder.push(clickedMemberName);
                    clickedCard.classList.add('selected');
                    clickedCard.querySelector('.selection-rank').textContent = selectionOrder.length;
                    clickedCard.querySelector('.selection-rank').style.opacity = '1';
                }
                if (selectionOrder.length === 1) {
                    processRoundResults();
                }
            }
        }

        function processRoundResults() {
            const currentSelectedCards = Array.from(memberSelectionDiv.querySelectorAll('.member-card'));

            // 모든 카드 클릭 비활성화
            currentSelectedCards.forEach(card => card.classList.add('processed'));

            if (gamePhase === 'initialSelection') {
                const rank1Member = selectionOrder[0];
                const rank2Member = selectionOrder[1];
                const unselectedMember = availableMembersForRound.find(name => name !== rank1Member && name !== rank2Member);

                // 점수 부여
                memberData[rank1Member].score += scores.phase1.rank1;
                memberData[rank1Member].firstRankSelections++; // 1순위 득표수 증가

                memberData[rank2Member].score += scores.phase1.rank2;
                memberData[rank2Member].secondRankSelections++; // 2순위 득표수 증가

                if (unselectedMember) {
                    memberData[unselectedMember].zeroScoreCount++;
                    if (memberData[unselectedMember].zeroScoreCount >= maxZeroScoreCount) {
                        memberData[unselectedMember].eliminated = true;
                        console.log(`${unselectedMember} 0점 3회로 탈락!`);
                    }
                }

                // 등장 횟수 및 함께 등장했던 멤버 기록
                availableMembersForRound.forEach(name => {
                    memberData[name].appearances++;
                    memberData[name].lastSeen = currentRound;
                    const otherMembersInGroup = new Set(availableMembersForRound.filter(m => m !== name));
                    memberData[name].previousRoundGroup = new Set([...memberData[name].previousRoundGroup, ...otherMembersInGroup]);
                });

            } else if (gamePhase === 'finalSelection' || gamePhase === 'tieBreakerForRank1') {
                const selectedMember = selectionOrder[0];
                const notSelectedMember = availableMembersForRound.find(name => name !== selectedMember);

                let currentScores;
                if (gamePhase === 'finalSelection') {
                    currentScores = scores.phase2;
                    memberData[selectedMember].firstRankSelections++; // 페이즈 2의 3점도 1순위 득표수에 포함
                } else { // tieBreakerForRank1
                    currentScores = scores.tieBreakerForRank1;
                    memberData[selectedMember].firstRankSelections++; // 결승 라운드 득점도 1순위 득표수에 포함
                    if(notSelectedMember) memberData[notSelectedMember].secondRankSelections++; // 결승 2순위 득점
                }

                memberData[selectedMember].score += currentScores.selected;
                if (notSelectedMember) {
                    memberData[notSelectedMember].score += currentScores.notSelected;
                    // 페이즈 2에서만 '선택받지 못한 횟수'를 기록
                    if (gamePhase === 'finalSelection') {
                        memberData[notSelectedMember].notSelectedCountPhase2++;
                        if (memberData[notSelectedMember].notSelectedCountPhase2 >= 4) {
                            memberData[notSelectedMember].eliminatedPhase2 = true;
                            console.log(`${notSelectedMember} 페이즈 2에서 4회 미선택으로 탈락!`);
                        }
                    }
                }
            }

            // 잠시 후 다음 라운드 시작
            setTimeout(() => {
                startNewRound();
            }, 1000);
        }

        function displayResults() {
            gameScreen.style.display = 'none';
            resultsScreen.style.display = 'block';
            tieBreakerInfoElement.style.display = 'none'; // 결과 화면에서는 동점자 정보 숨김

            const sortedMembers = getSortedMembers(true); // 모든 멤버 포함하여 최종 순위 정렬

            // 최종 3인 표시
            topMembersDisplay.innerHTML = '';
            const top3 = sortedMembers.slice(0, 3);
            if (top3[0]) {
                const rank1Card = createTopMemberCard(top3[0].name, top3[0].score, 1);
                topMembersDisplay.appendChild(rank1Card);
            }
            if (top3[1]) {
                const rank2Card = createTopMemberCard(top3[1].name, top3[1].score, 2);
                topMembersDisplay.appendChild(rank2Card);
            }
            if (top3[2]) {
                const rank3Card = createTopMemberCard(top3[2].name, top3[2].score, 3);
                topMembersDisplay.appendChild(rank3Card);
            }

            // 최종 선발 16인 리스트
            finalSelectionList.innerHTML = '';
            let final16 = sortedMembers.filter(m => !m.eliminated && !m.eliminatedPhase2).slice(0, initialSelectionTarget);

            // 공동 2등 처리: 3점 득표수로 정렬
            final16.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return b.firstRankSelections - a.firstRankSelections; // 3점 득표수 (phase2의 3점도 포함)
            });

            // 16인 초과시 자르거나, 공동 2위가 2명 초과시 3점 득표수로 2명까지
            const actualFinal16 = [];
            let currentRank = 1;
            let currentScore = -1;
            let currentFirstRankSelections = -1;
            let membersAtCurrentRank = 0;

            for (let i = 0; i < final16.length; i++) {
                const member = final16[i];
                if (i === 0) { // 첫 번째 멤버는 무조건 추가
                    actualFinal16.push(member.name);
                    currentScore = member.score;
                    currentFirstRankSelections = member.firstRankSelections;
                    membersAtCurrentRank = 1;
                } else if (member.score === currentScore && member.firstRankSelections === currentFirstRankSelections) {
                    // 점수와 3점 득표수가 같으면 같은 등수로 처리
                    membersAtCurrentRank++;
                    // 2등이 3명 이상일 때, 3점 득표수가 같은 멤버는 최대 2명까지만 허용 (2위만 해당)
                    if (actualFinal16.length < initialSelectionTarget - 1 && membersAtCurrentRank <= 2) { // 15번째까지는 2등 2명 허용
                         actualFinal16.push(member.name);
                    } else if (actualFinal16.length < initialSelectionTarget) { // 16번째는 단독 or 마지막 2등까지
                         actualFinal16.push(member.name);
                    }
                } else {
                    currentRank++;
                    currentScore = member.score;
                    currentFirstRankSelections = member.firstRankSelections;
                    membersAtCurrentRank = 1;

                    if (actualFinal16.length < initialSelectionTarget) {
                        actualFinal16.push(member.name);
                    } else {
                        break; // 16명 모두 채워지면 중단
                    }
                }
                 if (actualFinal16.length >= initialSelectionTarget) break;
            }


            actualFinal16.forEach(name => {
                const li = document.createElement('li');
                li.textContent = name;
                finalSelectionList.appendChild(li);
            });
        }


        function createTopMemberCard(name, score, rank) {
            const card = document.createElement('div');
            card.classList.add('top-member-card', `rank${rank}`);
            card.innerHTML = `
                <div class="rank-label">${rank}위</div>
                <img src="./images/${name}.png" alt="${name}">
                <p>${name}</p>
                <span class="score">${score}점</span>
            `;
            return card;
        }

        // 결과 저장 (텍스트)
        document.getElementById('downloadTextResultButton').addEventListener('click', () => {
            const sortedMembers = getSortedMembers(true);
            let textContent = "💖 MY HKT48 최종 선발 결과! 💖\n\n";

            textContent += "--- 최종 3인 ---\n";
            const top3 = sortedMembers.slice(0, 3);
            top3.forEach((m, index) => {
                textContent += `${index + 1}위: ${m.name} (${m.score}점)\n`;
            });

            textContent += "\n--- 최종 선발 16인 ---\n";
            let final16 = sortedMembers.filter(m => !m.eliminated && !m.eliminatedPhase2).slice(0, initialSelectionTarget);

            // 공동 2등 처리 로직 (displayResults와 동일하게 적용)
            final16.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return b.firstRankSelections - a.firstRankSelections;
            });

            const actualFinal16 = [];
            let currentScore = -1;
            let currentFirstRankSelections = -1;
            let membersAtCurrentRank = 0;

            for (let i = 0; i < final16.length; i++) {
                const member = final16[i];
                if (i === 0) {
                    actualFinal16.push(member.name);
                    currentScore = member.score;
                    currentFirstRankSelections = member.firstRankSelections;
                    membersAtCurrentRank = 1;
                } else if (member.score === currentScore && member.firstRankSelections === currentFirstRankSelections) {
                    membersAtCurrentRank++;
                    if (actualFinal16.length < initialSelectionTarget - 1 && membersAtCurrentRank <= 2) {
                         actualFinal16.push(member.name);
                    } else if (actualFinal16.length < initialSelectionTarget) {
                         actualFinal16.push(member.name);
                    }
                } else {
                    currentScore = member.score;
                    currentFirstRankSelections = member.firstRankSelections;
                    membersAtCurrentRank = 1;
                    if (actualFinal16.length < initialSelectionTarget) {
                        actualFinal16.push(member.name);
                    } else {
                        break;
                    }
                }
                if (actualFinal16.length >= initialSelectionTarget) break;
            }

            actualFinal16.forEach((name, index) => {
                textContent += `${index + 1}. ${name}\n`;
            });


            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'MY_HKT48_선발_결과.txt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // 결과 저장 (이미지)
        document.getElementById('downloadImageResultButton').addEventListener('click', () => {
            html2canvas(document.querySelector('.container'), {
                scale: 2, // 고해상도 이미지
                useCORS: true, // 이미지 로딩 문제 해결
                allowTaint: true, // 이미지 교차 출처 문제 (일부 브라우저에서 문제 될 수 있음)
            }).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = 'MY_HKT48_선발_결과.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });

        // 게임 초기화
        document.getElementById('resetGameButton').addEventListener('click', () => {
            if (confirm("게임을 정말로 초기화하시겠습니까? 현재 진행 상황은 모두 사라집니다.")) {
                initializeGame();
            }
        });

        // 새 게임 시작
        document.getElementById('restartGameButton').addEventListener('click', () => {
            if (confirm("새 게임을 시작하시겠습니까?")) {
                initializeGame();
            }
        });

        // 게임 시작
        initializeGame();
    </script>
</body>
</html>
