<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY HKT48 선발</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #fce4ec;
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            line-height: 1.6;
        }
        /* 바닥판 */
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
            width: 100%;
            max-width: 1160px;
            box-sizing: border-box;
            position: relative;
        }
        h1 {
            color: #ad1457;
            margin-bottom: 25px;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        h2 {
            color: #7b1fa2;
            margin-top: 20px;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .round-info {
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
            margin-bottom: 25px;
        }
        .member-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        /* 멤버카드 (분홍색 판) - PC 기본 스타일 */
        .member-card {
            background-color: #ffebee;
            border: 2px solid #ffccbc;
            border-radius: 15px;
            padding: 15px; /* PC 패딩 줄임 */
            width: 370px;
            min-width: 370px;
            flex-shrink: 0;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column; /* PC: 세로형 */
            align-items: center;
            box-sizing: border-box;
            position: relative;
        }
        .member-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border-color: #ff8a65;
        }
        .member-card.selected {
            border: 4px solid #ad1457;
            background-color: #ffebf0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            transform: translateY(-8px) scale(1.02);
        }
        .member-card.processed {
            pointer-events: none;
            opacity: 0.8;
        }

        /* 멤버 사진 - PC 기본 스타일 */
        .member-card img {
            width: 350px;
            height: 350px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px; /* PC 이미지 아래 여백 줄임 */
            transition: border-color 0.2s;
        }
        .member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.3em;
            word-break: keep-all;
        }

        /* 순위 표시 스타일 */
        .selection-rank {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: #ad1457;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .member-card.selected .selection-rank {
            opacity: 1;
        }

        .button-group {
            margin-top: 40px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            letter-spacing: 1px;
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        #resetGameButton {
            background-color: #f44336;
            color: white;
            margin-top: 20px; /* PC에서는 기존 위치 유지 */
        }
        #resetGameButton:hover {
            background-color: #d32f2f;
        }

        /* 결과 화면 스타일 */
        .results-screen {
            display: none;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px dashed #eee;
            text-align: left;
        }
        .results-screen h2 {
            text-align: center;
            color: #ad1457;
            font-size: 2.2em;
            margin-bottom: 30px;
        }
        .top-members {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 30px; /* 이미지 크기 증가에 맞춰 간격 조정 */
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .top-member-card {
            background-color: #fdf3f7;
            border-radius: 15px;
            padding: 30px; /* 패딩 늘림 */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            box-sizing: border-box;
            position: relative;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        /* 1위 카드 스타일 (2,3위보다 10% 더 크게) */
        .top-member-card.rank1 {
            width: calc(247.5px + 60px + 8px);
            height: auto;
            border: 4px solid #FFD700;
            background-color: #FFFACD;
            transform: translateY(-30px);
            order: 2;
        }
        .top-member-card.rank1 img {
            width: 247.5px;
            height: 247.5px;
        }

        /* 2, 3위 카드 스타일 (기준 크기) */
        .top-member-card.rank2, .top-member-card.rank3 {
            width: calc(225px + 60px + 8px);
            height: auto;
            border: 4px solid #C0C0C0;
            background-color: #E0E0E0;
            order: 1;
        }
        .top-member-card.rank3 {
            border: 4px solid #CD7F32;
            background-color: #D2B48C;
            order: 3;
        }
        .top-member-card.rank2 img, .top-member-card.rank3 img {
            width: 225px;
            height: 225px;
        }

        .top-member-card img {
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
        }
        .top-member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.4em;
            margin-bottom: 5px;
        }
        .top-member-card .score {
            font-size: 1.2em;
            color: #555;
            font-weight: normal;
            display: none; /* 점수 표시 비활성화 */
        }
        .rank-label {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ad1457;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .rank1 .rank-label { background-color: #FFD700; color: #333; }
        .rank2 .rank-label { background-color: #C0C0C0; color: #333; }
        .rank3 .rank-label { background-color: #CD7F32; color: white; }

        .final-selection-list {
            margin-top: 30px;
            text-align: center;
            font-size: 1.1em;
            color: #555;
            display: block; /* 항상 보이도록 설정 */
        }
        .final-selection-list h3 {
            color: #7b1fa2;
            margin-bottom: 15px;
            font-size: 1.6em;
        }
        .final-selection-list ul {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 700px;
            margin: 0 auto;
        }
        .final-selection-list li {
            background-color: #e3f2fd;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #bbdefb;
            font-weight: bold;
            color: #2196F3;
        }
        .restart-button-group {
            margin-top: 40px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .restart-button-group button {
            width: 250px;
        }
        /* 동점자 라운드 시 표시될 안내 텍스트 스타일 */
        .tie-breaker-info {
            font-weight: bold;
            color: #ad1457;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: none;
        }

        /* Welcome Screen Styles */
        #welcomeScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            text-align: center;
        }
        #welcomeScreen h2 {
            color: #ad1457;
            font-size: 2.2em;
            margin-bottom: 20px;
        }
        #welcomeScreen h3 {
            color: #7b1fa2;
            font-size: 1.5em;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        #welcomeScreen p {
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        #welcomeScreen ul {
            list-style: none;
            padding: 0;
            margin: 10px 0 20px 0;
            text-align: left;
            width: 100%;
            max-width: 500px;
        }
        #welcomeScreen li {
            background-color: #f3e5f5;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            border: 1px solid #ce93d8;
            font-size: 1em;
        }
        #startGameButton {
            background-color: #ad1457;
            color: white;
            padding: 18px 40px;
            font-size: 1.5em;
            margin-top: 30px;
            border-radius: 12px;
        }
        #startGameButton:hover {
            background-color: #880e4f;
        }


        @keyframes pulse {
            0% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
                max-width: 95%;
            }
            h1 {
                font-size: 1.8em;
            }
            /* 모바일에서 라운드 정보와 '오늘의 멤버' 문구 숨김 */
            .round-info, h2 {
                display: none;
            }
            /* 모바일 상단 안내 글자 간략화 및 크기 조정 */
            #instructionText {
                font-size: 0.9em;
                margin-top: 0;
                margin-bottom: 15px;
            }
            .member-display {
                flex-direction: column;
                align-items: center;
                gap: 10px;
                margin-top: 15px;
            }
            /* 멤버카드 - 모바일: 가로형 */
            .member-card {
                width: 95%;
                max-width: 350px;
                min-width: unset;
                padding: 8px 10px;
                flex-direction: row;
                justify-content: flex-start;
                align-items: center;
                gap: 8px;
            }
            .member-card:hover {
                transform: none;
                box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
            }
            .member-card.selected {
                transform: none;
            }

            /* 멤버 사진 - 모바일: 크기 20% 더 키움 */
            .member-card img {
                width: 72px; /* 60px * 1.2 = 72px */
                height: 72px; /* 60px * 1.2 = 72px */
                border-radius: 50%;
                object-fit: cover;
                margin-bottom: 0;
                flex-shrink: 0;
            }
            .member-card p {
                font-size: 1.1em;
                text-align: left;
                flex-grow: 1;
            }
            .selection-rank {
                top: 50%;
                left: unset;
                right: 8px;
                transform: translateY(-50%);
                width: 25px;
                height: 25px;
                font-size: 0.9em;
            }

            .button-group {
                flex-direction: column;
                gap: 10px;
                margin-top: 20px;
            }
            button {
                width: 90%;
                padding: 12px 20px;
                font-size: 1.1em;
            }
            /* 게임 초기화 버튼 모바일 스타일 변경 */
            #resetGameButton {
                width: 120px; /* 더 작게 */
                padding: 8px 15px; /* 패딩도 줄임 */
                font-size: 0.9em; /* 폰트도 작게 */
                margin-top: 0; /* 상단 마진 제거 */
                align-self: center; /* 가운데 정렬 */
                order: 10; /* 다른 버튼보다 아래로 내림 */
            }

            .top-members {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            .top-member-card {
                width: 90%;
                transform: none !important;
                order: initial !important;
            }
            .top-member-card.rank1 img {
                width: 180px;
                height: 180px;
            }
            .top-member-card.rank2 img, .top-member-card.rank3 img {
                width: 150px;
                height: 150px;
            }
            .restart-button-group button {
                width: 90%;
            }

            /* Welcome Screen Mobile Styles */
            #welcomeScreen h2 {
                font-size: 1.8em;
            }
            #welcomeScreen h3 {
                font-size: 1.3em;
            }
            #welcomeScreen p {
                font-size: 0.9em;
            }
            #welcomeScreen li {
                font-size: 0.9em;
                padding: 8px 10px;
            }
            #startGameButton {
                padding: 15px 30px;
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MY HKT48 선발</h1>

        <div id="welcomeScreen">
            <h2>MY HKT48 선발 게임에 오신 것을 환영합니다!</h2>
            
            <h3>게임 방식</h3>
            
            <h4>16인 선발전</h4>
            <ul>
                <li><strong>3명</strong>의 멤버가 등장합니다.</li>
                <li>이 중에서 <strong>가장 좋아하는 멤버 2명</strong>을 순서대로 선택하세요.</li>
            </ul>

            <h4>센터 선발전</h4>
            <ul>
                <li><strong>16명의 멤버</strong>가 선발되면, <strong>'당신의 센터를 뽑아주세요!'</strong>라는 안내 문구가 나타나며 게임 방식이 바뀝니다.</li>
                <li><strong>2명</strong>의 멤버가 등장하며, 이 중에서 <strong>당신의 센터</strong>라고 생각하는 한 명을 선택하세요.</li>
            </ul>

            <button id="startGameButton">게임 시작</button>
        </div>

        <div id="gameScreen" style="display: none;">
            <p id="instructionText" style="font-weight: bold; color: #ad1457;"></p>
            <p id="tieBreakerInfo" class="tie-breaker-info" style="display: none;">공동 1등 재대결 라운드!</p>

            <div class="round-info">
                <span id="currentRound"></span> 라운드
            </div>
            <h2 id="selectionInstruction"></h2>
            <div class="member-display" id="memberSelection">
            </div>
            <div class="button-group">
                <button id="resetGameButton">게임 초기화</button>
            </div>
        </div>

        <div id="resultsScreen" class="results-screen">
            <h2 id="resultsScreenTitle">🎉 최종 선발 결과! 🎉</h2>
            <div class="top-members" id="topMembersDisplay">
            </div>
            <div class="final-selection-list">
                <h3 id="finalSelectionListTitle">💖 최종 선발 16인 💖</h3>
                <ul id="finalSelectionList">
                </ul>
            </div>
            <div class="restart-button-group">
                <button id="downloadTextResultButton">결과 저장 (텍스트)</button>
                <button id="downloadImageResultButton">결과 저장 (이미지)</button>
                <button id="restartGameButton">새 게임 시작</button>
            </div>
        </div>
    </div>

    <script>
        const memberNames = [
            "나가노 라라", "나카노 미나미", "다나카 이오리", "류토 아야네", "마츠나가 유이", "마츠모토 모카",
            "모리사키 사아야", "사카모토 리노", "시부이 미나", "아오키 히나코", "아키요시 유카","야나세 레이아","야마우치 유나","야마카와 마리아",
            "야스이 히나", "에구치 코코하", "에우라 유카", "오오바 리사키", "오오우치 린카", "요시다 메이", "이마무라 마리아", "이시마츠 유이나",
            "이시바시 이부키", "이시이 아야네", "이시카와 아미유", "이하라 한나", "이자와 미유", "이지마 리리아", "이치무라 아이리", "이쿠노 리나",
            "지토우에 네네", "츠루카와 나치", "츠츠미 후카", "카타히라 사라", "쿠레 유나", "쿠리야마 리나", "쿠리하라 사에", "키타가와 히이로",
            "타치바나 코코로", "타케모토 쿠루미", "토요나가 아키", "후지노 코코하", "후쿠이 카렌"
        ];

        let memberData = {};
        let currentRound = 0;
        // 게임 페이즈: 'welcome', 'initialSelection', 'finalSelection', 'tieBreakerForRank1', 'results'
        let gamePhase = 'welcome';
        let selectionOrder = []; // 현재 라운드에서 선택된 멤버들의 이름 (순서대로)
        let availableMembersForRound = []; // 현재 라운드에 표시될 멤버들 (실제 렌더링될 멤버)

        const maxAppearancesPhase1 = 5; // 페이즈 1: 한 멤버는 5회 이상 등장하지 않음
        const maxZeroScoreCount = 3; // 페이즈 1: 0점 3번 받으면 탈락
        const maxNotSelectedCountPhase2 = 4; // 페이즈 2: 4번 이상 선택받지 못하면 더 이상 등장하지 않음

        const membersPerRoundPhase1 = 3; // 페이즈 1에서 보여주는 멤버 수 (3명)
        const membersPerRoundPhase2 = 2; // 페이즈 2와 결승에서 보여주는 멤버 수 (2명)

        const initialSelectionTarget = 16; // 1차 선발 목표 인원 (페이즈 1 종료 조건)

        // 라운드 간 딜레이 (0.1초 = 100ms)
        const roundDelay = 100;

        // 점수 정의 (게임 설명에는 언급하지 않음)
        const scores = {
            phase1: { // 1차 선발 단계 점수
                rank1: 5, // 1순위
                rank2: 3, // 2순위
                rank3: 0  // 3순위 (선택 없음)
            },
            phase2: { // 센터 선발 단계 점수
                selected: 3,   // 선택 받은 멤버
                notSelected: 1 // 선택 받지 못한 멤버
            },
            tieBreakerForRank1: { // 1등 동점자 결승 라운드 점수
                rank1: 20, // 1순위
                rank2: 10  // 2순위
            }
        };

        const welcomeScreen = document.getElementById('welcomeScreen');
        const startGameButton = document.getElementById('startGameButton');
        const instructionTextElement = document.getElementById('instructionText');
        const currentRoundElement = document.getElementById('currentRound');
        const selectionInstructionElement = document.getElementById('selectionInstruction'); // h2 태그
        const memberSelectionDiv = document.getElementById('memberSelection');
        const gameScreen = document.getElementById('gameScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const topMembersDisplay = document.getElementById('topMembersDisplay');
        const finalSelectionList = document.getElementById('finalSelectionList');
        const tieBreakerInfoElement = document.getElementById('tieBreakerInfo');

        function initializeGame() {
            memberData = {};
            memberNames.forEach(name => {
                memberData[name] = {
                    score: 0,
                    appearances: 0, // 페이즈 1 등장 횟수
                    zeroScoreCount: 0, // 페이즈 1: 0점 받은 횟수
                    notSelectedCountPhase2: 0, // 페이즈 2: 선택받지 못한 횟수 (1점 받은 횟수)
                    eliminated: false, // 페이즈 1 탈락 기준
                    eliminatedPhase2: false, // 페이즈 2 탈락 기준
                    lastSeen: -1, // 마지막 등장 라운드
                    previousRoundGroup: new Set(), // 함께 등장했던 멤버들 기록 (세트)
                    firstRankSelections: 0, // 1순위 선택 받은 횟수 (페이즈1: 5점, 페이즈2: 3점, 결승: 20점)
                    secondRankSelections: 0 // 2순위 선택 받은 횟수 (페이즈1: 3점, 결승: 10점)
                };
            });
            currentRound = 0;
            gamePhase = 'initialSelection'; // 게임 시작 버튼 클릭 시 initialSelection으로 바로 시작
            selectionOrder = [];
            availableMembersForRound = [];

            // 화면 전환
            welcomeScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            resultsScreen.style.display = 'none';
            tieBreakerInfoElement.style.display = 'none';

            updateInstructionText();
            startNewRound();
        }

        function updateInstructionText() {
            const nonEliminatedCount = Object.values(memberData).filter(m => !m.eliminated && !m.eliminatedPhase2).length;
            if (gamePhase === 'initialSelection') {
                instructionTextElement.textContent = `현재 인원: ${nonEliminatedCount}명. ${initialSelectionTarget}명을 선발 중입니다.`;
                selectionInstructionElement.textContent = `3명 중 좋아하는 순서대로 2명을 선택하세요!`;
                tieBreakerInfoElement.style.display = 'none';
            } else if (gamePhase === 'finalSelection') {
                instructionTextElement.textContent = `최종 선발 16인이 결정되었습니다. 당신의 센터를 뽑아주세요! (남은 멤버: ${nonEliminatedCount}명)`;
                selectionInstructionElement.textContent = `2명 중 우승자를 선택하세요!`;
                tieBreakerInfoElement.style.display = 'none';
            } else if (gamePhase === 'tieBreakerForRank1') {
                instructionTextElement.textContent = `공동 1등 발생! 단독 1등을 가리기 위한 결승 라운드!`;
                selectionInstructionElement.textContent = `2명 중 우승자를 선택하세요!`; // 결승은 항상 2명
                tieBreakerInfoElement.style.display = 'block';
            } else if (gamePhase === 'results') {
                instructionTextElement.textContent = `게임이 종료되었습니다! 최종 결과를 확인하세요.`;
                selectionInstructionElement.textContent = ``;
                tieBreakerInfoElement.style.display = 'none';
            }
        }

        // 멤버 정렬 함수: 점수 > 1순위 득표수 > 2순위 득표수 > 무작위 순
        function getSortedMembers(includeEliminated = false) {
            let filteredMembers = Object.keys(memberData).map(name => ({
                name: name,
                score: memberData[name].score,
                firstRankSelections: memberData[name].firstRankSelections,
                secondRankSelections: memberData[name].secondRankSelections,
                eliminated: memberData[name].eliminated || memberData[name].eliminatedPhase2
            }));

            if (!includeEliminated) {
                filteredMembers = filteredMembers.filter(m => !m.eliminated);
            }

            return filteredMembers.sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                // 점수 동점 시 1순위 득표수 비교 (페이즈 2의 3점 득표수 포함)
                if (b.firstRankSelections !== a.firstRankSelections) {
                    return b.firstRankSelections - a.firstRankSelections;
                }
                // 1순위 득표수도 동점 시 2순위 득표수 비교 (페이즈 2의 1점 득표수는 여기 포함 안됨)
                if (b.secondRankSelections !== a.secondRankSelections) {
                    return b.secondRankSelections - a.secondRankSelections;
                }
                // 최종 무작위
                return Math.random() - 0.5;
            });
        }


        function getEligibleMembersForRound(allowAppearanceRuleRelax = false, allowGroupRuleRelax = false) {
            let eligible = Object.keys(memberData).filter(name => !memberData[name].eliminated && !memberData[name].eliminatedPhase2);

            if (gamePhase === 'initialSelection') {
                if (!allowAppearanceRuleRelax) { // 규칙 완화가 허용되지 않았다면 등장 횟수 제한 적용
                    eligible = eligible.filter(name => memberData[name].appearances < maxAppearancesPhase1);
                }
            } else if (gamePhase === 'finalSelection') {
                // 페이즈 2에서는 등장 횟수 제한 없고, 4번 이상 선택받지 못한 멤버는 제외 (여기는 완화하지 않음)
                eligible = eligible.filter(name => memberData[name].notSelectedCountPhase2 < maxNotSelectedCountPhase2);

                // 현재 상위 16명 내의 멤버만 라운드에 등장하도록 (남은 멤버 중)
                const sortedMembers = getSortedMembers(false);
                const currentTop16Names = sortedMembers.slice(0, initialSelectionTarget).map(m => m.name);
                eligible = eligible.filter(name => currentTop16Names.includes(name));

            } else if (gamePhase === 'tieBreakerForRank1') {
                // 공동 1등 동점자 라운드: 현재 최고 점수 멤버들만 대상으로 하고, 등장 횟수/탈락 제한 없음
                const sortedMembers = getSortedMembers(false);
                if (sortedMembers.length === 0) return [];

                const topScore = sortedMembers[0].score;
                eligible = sortedMembers.filter(m => m.score === topScore).map(m => m.name);
            }
            return eligible;
        }

        function selectMembersForRound() {
            let selected = [];
            const numMembersToSelect = (gamePhase === 'initialSelection') ? membersPerRoundPhase1 : membersPerRoundPhase2;

            // 결승 라운드는 규칙 완화 없이 진행 (단, 멤버가 부족하면 빈 배열 반환)
            if (gamePhase === 'tieBreakerForRank1') {
                let eligiblePoolTieBreaker = getEligibleMembersForRound();
                if (eligiblePoolTieBreaker.length < numMembersToSelect) {
                    return []; // 결승 진행 불가
                }
                eligiblePoolTieBreaker.sort(() => Math.random() - 0.5);
                return eligiblePoolTieBreaker.slice(0, numMembersToSelect);
            }

            // 1단계: 엄격한 규칙 (등장 횟수, 그룹 제약) 적용하여 시도
            let eligiblePoolStrict = getEligibleMembersForRound(false, false);
            let attempts = 0;
            const maxAttempts = 500; // 충분한 시도 횟수

            if (eligiblePoolStrict.length >= numMembersToSelect) { // 엄격한 규칙으로 멤버를 충분히 뽑을 수 있다면 시도
                let tempEligiblePool = [...eligiblePoolStrict]; // 복사하여 사용
                tempEligiblePool.sort(() => Math.random() - 0.5);

                while (selected.length < numMembersToSelect && attempts < maxAttempts && tempEligiblePool.length > 0) {
                    const candidateIndex = Math.floor(Math.random() * tempEligiblePool.length);
                    const candidate = tempEligiblePool[candidateIndex];

                    let canAdd = true;
                    if (gamePhase === 'initialSelection') { // 그룹 등장 제한은 페이즈 1에만 적용
                        for (const existingMember of selected) {
                            if (memberData[existingMember].previousRoundGroup.has(candidate) ||
                                memberData[candidate].previousRoundGroup.has(existingMember)) {
                                canAdd = false;
                                break;
                            }
                        }
                    }

                    if (canAdd) {
                        selected.push(candidate);
                        tempEligiblePool.splice(candidateIndex, 1); // 선택된 멤버는 후보 풀에서 제거
                    }
                    attempts++;
                }
            }


            // 2단계: 엄격한 규칙으로 못 뽑았다면, '함께 등장했던 그룹' 규칙 완화하여 재시도 (페이즈 1 & 2)
            if (selected.length < numMembersToSelect) {
                console.warn("경고: 함께 등장했던 그룹 규칙 때문에 충분한 멤버를 찾지 못하여 규칙을 완화합니다.");
                selected = []; // 기존에 뽑힌 멤버 초기화
                let eligiblePoolRelaxGroup = getEligibleMembersForRound(false, true); // 등장 횟수만 지킴 (그룹 제한 무시)
                eligiblePoolRelaxGroup.sort(() => Math.random() - 0.5); // 다시 섞기
                attempts = 0;

                let tempEligiblePool = [...eligiblePoolRelaxGroup];

                while (selected.length < numMembersToSelect && attempts < maxAttempts * 2 && tempEligiblePool.length > 0) {
                    const candidateIndex = Math.floor(Math.random() * tempEligiblePool.length);
                    const candidate = tempEligiblePool[candidateIndex];
                    selected.push(candidate);
                    tempEligiblePool.splice(candidateIndex, 1);
                    attempts++;
                }
            }

            // 3단계: 그래도 부족하면, '등장 횟수' 규칙 완화하여 재시도 (페이즈 1에만 해당)
            // 페이즈 2는 이미 등장 횟수 제한 없음 (getEligibleMembersForRound의 로직 확인)
            if (gamePhase === 'initialSelection' && selected.length < numMembersToSelect) {
                console.warn("경고: 등장 횟수 규칙 때문에 충분한 멤버를 찾지 못하여 규칙을 완화합니다.");
                selected = []; // 기존에 뽑힌 멤버 초기화
                let eligiblePoolRelaxAll = getEligibleMembersForRound(true, true); // 모든 규칙 완화 (등장 횟수, 그룹)
                eligiblePoolRelaxAll.sort(() => Math.random() - 0.5); // 다시 섞기
                attempts = 0;

                let tempEligiblePool = [...eligiblePoolRelaxAll];
                while (selected.length < numMembersToSelect && attempts < maxAttempts * 3 && tempEligiblePool.length > 0) {
                    const candidateIndex = Math.floor(Math.random() * tempEligiblePool.length);
                    const candidate = tempEligiblePool[candidateIndex];
                    selected.push(candidate);
                    tempEligiblePool.splice(candidateIndex, 1);
                    attempts++;
                }
            }

            // 4단계: 최후의 수단 - 강제로 필요한 수만큼 채움 (남은 멤버 중 무작위)
            // 모든 규칙을 완화했음에도 멤버가 부족하면, 강제로 채워 넣음
            if (selected.length < numMembersToSelect) {
                console.warn("경고: 모든 규칙을 완화했음에도 멤버가 부족합니다. 남은 멤버 중 무작위로 채워 넣습니다.");
                const allRemainingEligible = Object.keys(memberData).filter(name =>
                    !memberData[name].eliminated && !memberData[name].eliminatedPhase2 && !selected.includes(name)
                );
                allRemainingEligible.sort(() => Math.random() - 0.5);

                while (selected.length < numMembersToSelect && allRemainingEligible.length > 0) {
                    selected.push(allRemainingEligible.shift());
                }
            }

            return selected;
        }


        function startNewRound() {
            currentRound++;
            currentRoundElement.textContent = currentRound;
            selectionOrder = []; // 새 라운드 시작 시 선택 순서 초기화
            memberSelectionDiv.innerHTML = ''; // 이전 멤버 카드 제거

            const nonEliminatedCount = Object.values(memberData).filter(m => !m.eliminated && !m.eliminatedPhase2).length;
            const sortedMembers = getSortedMembers(false); // 현재 점수 기준 정렬 (탈락자 제외)

            // 1. 페이즈 전환 및 게임 종료 조건 확인
            if (gamePhase === 'initialSelection') {
                // 페이즈 1 -> 페이즈 2 전환 조건: 남은 멤버가 16명 이하일 때
                if (nonEliminatedCount <= initialSelectionTarget) {
                    gamePhase = 'finalSelection';
                    currentRound = 0; // 페이즈 변경 시 라운드 초기화
                    // alert(`1차 선발이 완료되었습니다! 이제 최종 선발 16인을 위한 경쟁을 시작합니다.`); // 알림 제거
                }
            } else if (gamePhase === 'finalSelection') {
                // 페이즈 2 종료 조건: 등장 가능한 멤버가 1명 이하일 때
                const eligibleForPhase2 = getEligibleMembersForRound();
                if (eligibleForPhase2.length <= 1) { // 1명만 남았거나 더 이상 진행할 수 없는 경우
                    // 이제 공동 1등 검사 로직 추가 (기존에는 여기서 바로 종료였음)
                    const topScorers = getSortedMembers(false).filter((m, i, arr) => i === 0 || m.score === arr[0].score);
                    if (topScorers.length > 1) {
                        gamePhase = 'tieBreakerForRank1';
                        // console.log('공동 1등 발생! 결승 라운드로 전환:', topScorers.map(m => m.name)); // 디버그
                        // 결승 라운드는 별도로 시작, 여기서는 바로 다음 단계로 넘어가지 않고 리턴
                    } else {
                        // 단독 1등이 확정되었거나 더 이상 진행할 멤버가 없는 경우
                        gamePhase = 'results';
                        displayResults();
                        return;
                    }
                }
            } else if (gamePhase === 'tieBreakerForRank1') {
                // 결승 라운드 종료 조건: 1명만 남거나, 더 이상 라운드 진행 불가
                const eligibleForTieBreaker = getEligibleMembersForRound();
                if (eligibleForTieBreaker.length <= 1) {
                    gamePhase = 'results';
                    displayResults();
                    return;
                }
            }


            updateInstructionText();

            // 2. 라운드에 표시할 멤버 선택
            availableMembersForRound = selectMembersForRound();

            // 만약 더 이상 진행할 멤버가 없다면 바로 결과 화면으로
            if (availableMembersForRound.length === 0) {
                console.warn("더 이상 라운드를 진행할 멤버가 없습니다. 결과를 표시합니다.");
                gamePhase = 'results';
                displayResults();
                return;
            }

            // 3. 멤버 카드 생성 및 표시
            availableMembersForRound.forEach(memberName => {
                const memberCard = document.createElement('div');
                memberCard.classList.add('member-card');
                memberCard.dataset.name = memberName;

                // 이미지 경로 설정: PNG 파일임을 명시합니다.
                const imageName = memberName.replace(/\s/g, '_') + '.png'; // 공백을 언더스코어로 변경하고 .png 확장자 추가
                const imagePath = `img/${imageName}`; // 'img' 폴더에 이미지가 있다고 가정
                
                memberCard.innerHTML = `
                    <img src="${imagePath}" alt="${memberName}">
                    <p>${memberName}</p>
                    <div class="selection-rank"></div>
                `;
                memberCard.addEventListener('click', () => selectMember(memberName));
                memberSelectionDiv.appendChild(memberCard);

                // 등장 횟수 업데이트
                memberData[memberName].appearances++;
                memberData[memberName].lastSeen = currentRound;

                // 함께 등장했던 멤버 기록 업데이트
                const currentRoundGroup = availableMembersForRound.filter(m => m !== memberName);
                currentRoundGroup.forEach(otherMember => {
                    memberData[memberName].previousRoundGroup.add(otherMember);
                });
            });
        }


        function selectMember(selectedName) {
            const memberCard = document.querySelector(`.member-card[data-name="${selectedName}"]`);

            if (memberCard.classList.contains('processed')) {
                return; // 이미 처리된 카드는 클릭 무시
            }

            // 페이즈 1 (16인 선발전)
            if (gamePhase === 'initialSelection') {
                if (selectionOrder.length < 2) {
                    selectionOrder.push(selectedName);
                    memberCard.classList.add('selected');
                    memberCard.querySelector('.selection-rank').textContent = selectionOrder.length;

                    if (selectionOrder.length === 2) {
                        setTimeout(() => processSelectionsInitialPhase(), roundDelay);
                    }
                }
            }
            // 페이즈 2 (센터 선발전) 또는 결승 라운드 (공동 1등)
            else if (gamePhase === 'finalSelection' || gamePhase === 'tieBreakerForRank1') {
                selectionOrder.push(selectedName);
                memberCard.classList.add('selected');
                memberCard.querySelector('.selection-rank').textContent = 1; // 단일 선택이므로 항상 1위로 표시

                setTimeout(() => processSelectionsFinalPhase(), roundDelay);
            }
        }


        function processSelectionsInitialPhase() {
            const allSelectedMembers = availableMembersForRound; // 이 라운드에 표시된 모든 멤버

            allSelectedMembers.forEach(name => {
                const memberCard = document.querySelector(`.member-card[data-name="${name}"]`);
                memberCard.classList.add('processed'); // 카드 비활성화

                if (name === selectionOrder[0]) { // 1순위 선택
                    memberData[name].score += scores.phase1.rank1;
                    memberData[name].firstRankSelections++;
                    memberData[name].zeroScoreCount = 0; // 점수를 얻었으므로 0점 카운트 초기화
                } else if (name === selectionOrder[1]) { // 2순위 선택
                    memberData[name].score += scores.phase1.rank2;
                    memberData[name].secondRankSelections++;
                    memberData[name].zeroScoreCount = 0; // 점수를 얻었으므로 0점 카운트 초기화
                } else { // 선택되지 않은 멤버 (3순위)
                    memberData[name].score += scores.phase1.rank3; // 0점 추가 (변화 없음)
                    memberData[name].zeroScoreCount++;
                    if (memberData[name].zeroScoreCount >= maxZeroScoreCount) {
                        memberData[name].eliminated = true; // 3번 이상 0점이면 탈락
                        console.log(`${name} (initialSelection) 3회 0점 획득으로 탈락!`);
                    }
                }
            });

            setTimeout(startNewRound, roundDelay * 2); // 다음 라운드 시작
        }

        function processSelectionsFinalPhase() {
            const selectedMember = selectionOrder[0];
            const unselectedMember = availableMembersForRound.find(name => name !== selectedMember);

            const scoreType = gamePhase === 'tieBreakerForRank1' ? 'tieBreakerForRank1' : 'phase2';

            // 선택된 멤버 처리
            memberData[selectedMember].score += scores[scoreType].selected;
            memberData[selectedMember].firstRankSelections++; // 1순위 득표수 카운트
            memberData[selectedMember].notSelectedCountPhase2 = 0; // 선택받았으니 카운트 초기화

            // 선택되지 않은 멤버 처리
            if (unselectedMember) {
                memberData[unselectedMember].score += scores[scoreType].notSelected;
                // 페이즈 2에서만 탈락 기준 적용
                if (gamePhase === 'finalSelection') {
                    memberData[unselectedMember].notSelectedCountPhase2++;
                    if (memberData[unselectedMember].notSelectedCountPhase2 >= maxNotSelectedCountPhase2) {
                        memberData[unselectedMember].eliminatedPhase2 = true;
                        console.log(`${unselectedMember} (finalSelection) 4회 미선택으로 탈락!`);
                    }
                }
            }

            // 모든 카드 비활성화
            availableMembersForRound.forEach(name => {
                const memberCard = document.querySelector(`.member-card[data-name="${name}"]`);
                memberCard.classList.add('processed');
            });

            setTimeout(startNewRound, roundDelay * 2); // 다음 라운드 시작
        }


        function displayResults() {
            gameScreen.style.display = 'none';
            resultsScreen.style.display = 'block';
            topMembersDisplay.innerHTML = '';
            finalSelectionList.innerHTML = '';

            const sortedMembers = getSortedMembers(true); // 모든 멤버를 점수순으로 정렬

            // 상위 3명 표시
            const top3 = sortedMembers.slice(0, 3);
            top3.forEach((member, index) => {
                const rank = index + 1;
                const memberCard = document.createElement('div');
                memberCard.classList.add('top-member-card', `rank${rank}`);
                // 이미지 경로 설정: PNG 파일임을 명시합니다.
                memberCard.innerHTML = `
                    <div class="rank-label">${rank}위</div>
                    <img src="img/${member.name.replace(/\s/g, '_')}.png" alt="${member.name}">
                    <p>${member.name}</p>
                    <p class="score">점수: ${member.score}</p>
                `;
                topMembersDisplay.appendChild(memberCard);
            });

            // 최종 선발 16인 리스트 (점수가 0보다 크거나, 탈락하지 않은 멤버 중 상위 16명)
            // 기준: 탈락하지 않은 멤버 중 점수가 높은 순으로 16명
            const final16Members = getSortedMembers(false).slice(0, initialSelectionTarget);

            if (final16Members.length > 0) {
                final16Members.forEach((member, index) => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${index + 1}위: ${member.name} (${member.score}점)`;
                    finalSelectionList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = "선발된 멤버가 없습니다.";
                finalSelectionList.appendChild(listItem);
            }
        }


        // 이벤트 리스너
        startGameButton.addEventListener('click', initializeGame);
        document.getElementById('resetGameButton').addEventListener('click', () => {
            if (confirm('정말로 게임을 처음부터 초기화하시겠습니까?')) {
                welcomeScreen.style.display = 'flex';
                gameScreen.style.display = 'none';
                resultsScreen.style.display = 'none';
                initializeGame(); // 초기화 후 바로 게임 시작하도록 변경 (선택사항)
                // 만약 초기화 시 welcome 화면으로만 가고 싶다면 위 initializeGame() 호출 제거
            }
        });
        document.getElementById('restartGameButton').addEventListener('click', initializeGame);

        document.getElementById('downloadTextResultButton').addEventListener('click', () => {
            const sortedMembers = getSortedMembers(true);
            let resultText = "MY HKT48 선발 최종 결과\n\n";
            resultText += "🏆 TOP 3 🏆\n";
            sortedMembers.slice(0, 3).forEach((m, i) => {
                resultText += `${i + 1}위: ${m.name} (${m.score}점)\n`;
            });
            resultText += "\n💖 최종 선발 16인 💖\n";
            getSortedMembers(false).slice(0, initialSelectionTarget).forEach((m, i) => {
                resultText += `${i + 1}위: ${m.name} (${m.score}점)\n`;
            });

            const blob = new Blob([resultText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my_hkt48_ranking_results.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.getElementById('downloadImageResultButton').addEventListener('click', () => {
            const container = document.querySelector('.container');
            html2canvas(container, {
                scale: 2, // 고해상도 이미지
                useCORS: true, // 이미지 로드 시 CORS 문제 해결
                allowTaint: true, // 이미지 오염 허용 (외부 이미지 사용 시 필요할 수 있음)
                ignoreElements: (element) => {
                    // 버튼은 스크린샷에서 제외
                    return element.tagName === 'BUTTON' || element.id === 'downloadTextResultButton' || element.id === 'downloadImageResultButton' || element.id === 'restartGameButton';
                }
            }).then(canvas => {
                const imageData = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = imageData;
                a.download = 'my_hkt48_ranking_results.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
        });

        // Initialize welcome screen on load
        window.onload = () => {
            welcomeScreen.style.display = 'flex';
            gameScreen.style.display = 'none';
            resultsScreen.style.display = 'none';
        };

    </script>
</body>
</html>
